name: Build Corne Vial Firmware

on:
  push:
    branches: [main]
    paths:
      - "keymaps/**"
      - ".github/workflows/**"
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build-uf2:
    runs-on: ubuntu-latest
    container: ghcr.io/qmk/qmk_cli
    name: Build Corne Vial firmware (RP2040)
    
    steps:
      - name: Desabilita verifica√ß√µes de diret√≥rio git
        run: git config --global --add safe.directory '*'

      - name: Checkout Vial-QMK
        uses: actions/checkout@v4
        with:
          repository: vial-kb/vial-qmk
          submodules: recursive

      - name: Checkout reposit√≥rio
        uses: actions/checkout@v4
        with:
          path: temp_repo

      - name: Copia keymap para Vial-QMK
        run: |
          echo "üìÅ Copiando keymap..."
          mkdir -p keyboards/crkbd/keymaps/vial
          cp temp_repo/keymaps/keymap.c  keyboards/crkbd/keymaps/vial/keymap.c
          cp temp_repo/keymaps/config.h  keyboards/crkbd/keymaps/vial/config.h
          cp temp_repo/keymaps/rules.mk  keyboards/crkbd/keymaps/vial/rules.mk
          cp temp_repo/keymaps/vial.json keyboards/crkbd/keymaps/vial/vial.json
          echo "‚úÖ Arquivos copiados"

      - name: Compila firmware
        run: |
          echo "üîç Compilando firmware UF2..."
          make crkbd/rev1:vial CONVERT_TO=rp2040_ce
          echo "‚úÖ Compila√ß√£o conclu√≠da"
          
          echo "üîé Procurando arquivos .uf2:"
          find . -name "*.uf2" -type f -exec realpath {} \;

      - name: Verifica arquivo UF2
        id: check_files
        run: |
          echo "üîç Verificando arquivo UF2..."
          
          UF2_FILE="crkbd_rev1_vial_rp2040_ce.uf2"
          if [ -f "$UF2_FILE" ]; then
            echo "‚úÖ Arquivo encontrado: $UF2_FILE"
            ls -lh "$UF2_FILE"
            echo "uf2_exists=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Arquivo n√£o encontrado"
            echo "üìÅ Arquivos .uf2 dispon√≠veis:"
            find . -name "*.uf2" -type f
            exit 1
          fi

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        if: steps.check_files.outputs.uf2_exists == 'true'
        with:
          name: corne-vial-firmware-${{ github.sha }}
          path: crkbd_rev1_vial_rp2040_ce.uf2
          if-no-files-found: error